<!DOCTYPE html>
<html>
<head>
  <title>Habit Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA Configuration -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#58a6ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Habits">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-primary: #30363d;
      --border-secondary: #1b1f23;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --accent-blue: #58a6ff;
      --accent-green: #39d353;
      --accent-orange: #f97316;
      --accent-red: #f85149;
      --day-empty: #0d1117;
      --day-pending: #161b22;
      --day-missed: #1c1c1c;
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f6f8fa;
      --bg-tertiary: #e1e4e8;
      --border-primary: #d0d7de;
      --border-secondary: #d8dee4;
      --text-primary: #24292f;
      --text-secondary: #57606a;
      --accent-blue: #0969da;
      --accent-green: #1a7f37;
      --accent-orange: #d97706;
      --accent-red: #cf222e;
      --day-empty: #ffffff;
      --day-pending: #eaeef2;
      --day-missed: #d0d7de;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 16px;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .theme-toggle {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 20px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-blue);
    }

    .year-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      padding: 8px 16px;
    }

    .year-selector button {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      color: var(--text-primary);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .year-selector button:hover:not(:disabled) {
      background: var(--border-primary);
      border-color: var(--accent-blue);
    }

    .year-selector button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .year-selector span {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-blue);
      min-width: 60px;
      text-align: center;
    }

    .view-toggle {
      display: flex;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      overflow: hidden;
    }

    .view-toggle button {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .view-toggle button.active {
      background: var(--accent-blue);
      color: white;
    }

    .view-toggle button:hover:not(.active) {
      background: var(--bg-tertiary);
    }

    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
      padding: 0 4px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-blue);
      margin-bottom: 4px;
    }

    .stat-value.streak {
      color: var(--accent-orange);
    }

    .stat-value.completed {
      color: var(--accent-green);
    }

    .stat-value.missed {
      color: var(--accent-red);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: #238636;
    }

    .btn-primary:hover {
      background: #2ea043;
    }

    .btn-secondary {
      background: #1f6feb;
    }

    .btn-secondary:hover {
      background: #388bfd;
    }

    .btn-warning {
      background: #da3633;
    }

    .btn-warning:hover {
      background: #f85149;
    }

    .btn-purple {
      background: #8b5cf6;
    }

    .btn-purple:hover {
      background: #a78bfa;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .file-input {
      display: none;
    }

    .notification-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      margin-bottom: 24px;
      font-size: 13px;
    }

    .notification-status.enabled {
      border-color: var(--accent-green);
      background: rgba(57, 211, 83, 0.1);
    }

    .notification-status.disabled {
      border-color: var(--accent-orange);
      background: rgba(249, 115, 22, 0.1);
    }

    .calendar-wrapper {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px 8px;
      overflow-x: auto;
      transition: all 0.3s;
    }

    .months {
      display: grid;
      grid-auto-flow: column;
      grid-template-columns: repeat(53, 16px);
      gap: 3px;
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      padding-left: 28px;
    }

    .calendar-grid {
      display: flex;
      gap: 8px;
    }

    .days-labels {
      display: grid;
      grid-template-rows: repeat(7, 16px);
      gap: 3px;
      font-size: 9px;
      color: var(--text-secondary);
      text-align: right;
      padding-right: 6px;
      padding-top: 1px;
    }

    .days-labels div {
      line-height: 16px;
    }

    .calendar {
      display: flex;
      gap: 3px;
    }

    .week {
      display: grid;
      grid-template-rows: repeat(7, 16px);
      gap: 3px;
    }

    .day {
      width: 16px;
      height: 16px;
      background: var(--day-pending);
      border: 1px solid var(--border-secondary);
      border-radius: 2px;
      cursor: default;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .day.empty {
      background: transparent;
      border: none;
    }

    .day.future {
      background: var(--day-empty);
      border: 1px solid var(--border-secondary);
      opacity: 0.3;
    }

    .day.missed {
      background: var(--day-missed);
      border: 1px solid var(--border-primary);
      opacity: 0.6;
    }

    .day.completed {
      background: var(--accent-green);
      border: 1px solid #26a641;
      animation: completeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .day.today {
      border: 2px solid var(--accent-blue);
      cursor: pointer;
      animation: pulse 2s infinite;
    }

    .day.today:active {
      transform: scale(1.3);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(88, 166, 255, 0); }
    }

    @keyframes completeIn {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Monthly View Styles */
    .monthly-view {
      display: none;
    }

    .monthly-view.active {
      display: block;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .month-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      padding: 16px;
    }

    .month-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      text-align: center;
    }

    .month-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .month-day-label {
      font-size: 9px;
      color: var(--text-secondary);
      text-align: center;
      padding: 4px 0;
      font-weight: 600;
    }

    .month-day {
      aspect-ratio: 1;
      background: var(--day-pending);
      border: 1px solid var(--border-secondary);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: default;
      transition: all 0.2s;
    }

    .month-day.empty {
      background: transparent;
      border: none;
    }

    .month-day.future {
      background: var(--day-empty);
      opacity: 0.3;
    }

    .month-day.missed {
      background: var(--day-missed);
      opacity: 0.6;
    }

    .month-day.completed {
      background: var(--accent-green);
      color: white;
      font-weight: 600;
    }

    .month-day.today {
      border: 2px solid var(--accent-blue);
      cursor: pointer;
    }

    .tooltip {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 11px;
      color: var(--text-primary);
      pointer-events: none;
      z-index: 1000;
      white-space: nowrap;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      display: none;
    }

    .tooltip.show {
      display: block;
      animation: fadeIn 0.15s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .legend {
      margin-top: 20px;
      font-size: 10px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      border: 1px solid var(--border-secondary);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .modal-content h3 {
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .modal-content p {
      margin-bottom: 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    #shareCanvas {
      display: none;
    }

    @media (max-width: 768px) {
      body { padding: 16px 8px; }
      h1 { font-size: 22px; }
      .header { flex-direction: column; }
      .header-controls { width: 100%; justify-content: center; }
      .stats-bar { gap: 8px; grid-template-columns: repeat(2, 1fr); }
      .stat-card { padding: 12px; }
      .stat-value { font-size: 24px; }
      .calendar-wrapper { padding: 16px 4px; }
      .button-group { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>My Habit Tracker</h1>
    <div class="header-controls">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <span id="themeIcon">üåô</span>
      </button>
      <div class="view-toggle">
        <button class="active" onclick="switchView('year')">Year</button>
        <button onclick="switchView('month')">Monthly</button>
      </div>
      <div class="year-selector">
        <button onclick="changeYear(-1)" id="prevYear">‚óÄ</button>
        <span id="currentYear">2026</span>
        <button onclick="changeYear(1)" id="nextYear" disabled>‚ñ∂</button>
      </div>
    </div>
  </div>

  <div class="notification-status" id="notificationStatus">
    <span id="notificationText">üîî Enable notifications for daily reminders at 11 PM</span>
    <button class="btn btn-secondary" style="margin-left: auto; padding: 6px 12px; font-size: 12px;" onclick="requestNotificationPermission()">Enable</button>
  </div>
  
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-value streak" id="currentStreak">0</div>
      <div class="stat-label">Current Streak</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="longestStreak">0</div>
      <div class="stat-label">Longest Streak</div>
    </div>
    <div class="stat-card">
      <div class="stat-value completed" id="daysCompleted">0</div>
      <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value missed" id="daysMissed">0</div>
      <div class="stat-label">Missed</div>
    </div>
  </div>

  <div class="button-group">
    <button class="btn btn-purple" onclick="shareStats()">üì∏ Share Stats</button>
    <button class="btn btn-primary" onclick="exportStats()">üìä Export Stats</button>
    <button class="btn btn-secondary" onclick="backupData()">üíæ Backup</button>
    <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">üì• Restore</button>
  </div>

  <input type="file" id="restoreFile" class="file-input" accept=".json" onchange="restoreData(event)">

  <!-- Year View -->
  <div class="calendar-wrapper year-view active" id="yearView">
    <div class="months" id="months"></div>
    <div class="calendar-grid">
      <div class="days-labels">
        <div></div>
        <div>Mon</div>
        <div></div>
        <div>Wed</div>
        <div></div>
        <div>Fri</div>
        <div></div>
      </div>
      <div class="calendar" id="calendar"></div>
    </div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="legend-box" style="background: var(--day-empty); opacity: 0.3;"></div>
        <span>Future</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: var(--day-missed);"></div>
        <span>Missed</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: var(--day-pending);"></div>
        <span>Pending</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: var(--accent-green);"></div>
        <span>Completed</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: transparent; border: 2px solid var(--accent-blue);"></div>
        <span>Today</span>
      </div>
    </div>
  </div>

  <!-- Monthly View -->
  <div class="monthly-view" id="monthlyView">
    <div class="month-grid" id="monthGrid"></div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>
<canvas id="shareCanvas"></canvas>

<div class="modal" id="confirmModal">
  <div class="modal-content">
    <h3>‚ö†Ô∏è Restore Data</h3>
    <p>This will replace all your current data. Are you sure?</p>
    <div class="modal-buttons">
      <button class="btn btn-warning" onclick="confirmRestore()">Yes, Restore</button>
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  let selectedYear = new Date().getFullYear();
  let pendingRestoreData = null;
  let currentView = 'year';

  // Theme Management
  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    document.getElementById('themeIcon').textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', newTheme);
  }

  function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').textContent = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
  }

  // View Switching
  function switchView(view) {
    currentView = view;
    const yearView = document.getElementById('yearView');
    const monthlyView = document.getElementById('monthlyView');
    const buttons = document.querySelectorAll('.view-toggle button');

    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (view === 'year') {
      yearView.classList.add('active');
      monthlyView.classList.remove('active');
      buttons[0].classList.add('active');
    } else {
      yearView.classList.remove('active');
      monthlyView.classList.add('active');
      buttons[1].classList.add('active');
      renderMonthlyView();
    }
  }

  // Notification Management
  function checkNotificationStatus() {
    const statusDiv = document.getElementById('notificationStatus');
    const textSpan = document.getElementById('notificationText');
    
    if (!('Notification' in window)) {
      statusDiv.style.display = 'none';
      return;
    }

    if (Notification.permission === 'granted') {
      statusDiv.classList.remove('disabled');
      statusDiv.classList.add('enabled');
      textSpan.textContent = '‚úì Daily reminders enabled (11 PM)';
      statusDiv.querySelector('button').style.display = 'none';
      scheduleNotification();
    } else if (Notification.permission === 'denied') {
      statusDiv.classList.add('disabled');
      textSpan.textContent = 'üîï Notifications blocked. Enable in browser settings.';
      statusDiv.querySelector('button').style.display = 'none';
    }
  }

  function requestNotificationPermission() {
    if (!('Notification' in window)) {
      alert('Your browser does not support notifications');
      return;
    }

    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        new Notification('üéâ Habit Tracker', {
          body: 'Daily reminders enabled! You\'ll get notified at 11 PM.',
          icon: '‚úì'
        });
        checkNotificationStatus();
      }
    });
  }

  function scheduleNotification() {
    // Check every hour if it's 11 PM
    setInterval(() => {
      const now = new Date();
      if (now.getHours() === 23 && now.getMinutes() === 0) {
        checkAndSendNotification();
      }
    }, 60000); // Check every minute
  }

  function checkAndSendNotification() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const key = today.toISOString().split('T')[0];
    
    if (localStorage.getItem(key) !== '1' && Notification.permission === 'granted') {
      new Notification('üéØ Habit Tracker Reminder', {
        body: 'Don\'t forget to mark your habit for today!',
        icon: '‚è∞',
        tag: 'habit-reminder',
        requireInteraction: true
      });
    }
  }

  // Calendar Rendering
  function renderCalendar() {
    const calendar = document.getElementById("calendar");
    const monthsDiv = document.getElementById("months");

    calendar.innerHTML = '';
    monthsDiv.innerHTML = '';

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const currentYear = today.getFullYear();
    const isCurrentYear = selectedYear === currentYear;
    
    const startOfYear = new Date(selectedYear, 0, 1);
    const startDate = new Date(startOfYear);
    const dayOfWeek = startDate.getDay();
    startDate.setDate(startDate.getDate() - dayOfWeek);

    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    let current = new Date(startDate);
    let currentMonth = -1;
    let monthPositions = [];

    for (let week = 0; week < 53; week++) {
      const weekDiv = document.createElement("div");
      weekDiv.classList.add("week");
      calendar.appendChild(weekDiv);

      const monthChanged = current.getMonth() !== currentMonth && current.getFullYear() === selectedYear;
      if (week === 0 || monthChanged) {
        if (current.getFullYear() === selectedYear) {
          monthPositions.push({ week, month: monthNames[current.getMonth()] });
          currentMonth = current.getMonth();
        }
      }

      for (let day = 0; day < 7; day++) {
        const dayDiv = document.createElement("div");
        dayDiv.classList.add("day");

        const currentDateOnly = new Date(current);
        currentDateOnly.setHours(0, 0, 0, 0);

        const isFuture = currentDateOnly > today;
        const isToday = isCurrentYear && currentDateOnly.getTime() === today.getTime();
        const isBeforeYearStart = currentDateOnly < startOfYear;
        const isAfterYearEnd = currentDateOnly.getFullYear() > selectedYear;
        const key = current.toISOString().split("T")[0];

        if (isBeforeYearStart || isAfterYearEnd) {
          dayDiv.classList.add("empty");
        } else if (isFuture) {
          dayDiv.classList.add("future");
        } else if (isToday) {
          dayDiv.classList.add("today");
          dayDiv.dataset.date = key;
          
          if (localStorage.getItem(key) === "1") {
            dayDiv.classList.add("completed");
          }

          dayDiv.addEventListener("click", () => {
            const isCompleted = dayDiv.classList.contains("completed");
            
            if (isCompleted) {
              dayDiv.classList.remove("completed");
              localStorage.setItem(key, "0");
            } else {
              dayDiv.classList.add("completed");
              localStorage.setItem(key, "1");
            }
            
            updateStats();
          });

          const dateStr = current.toLocaleDateString('en-US', { 
            weekday: 'short', month: 'short', day: 'numeric' 
          });
          
          addTooltip(dayDiv, dateStr, true, key);

        } else {
          const storedValue = localStorage.getItem(key);
          
          if (storedValue === "1") {
            dayDiv.classList.add("completed");
          } else {
            dayDiv.classList.add("missed");
          }

          const dateStr = current.toLocaleDateString('en-US', { 
            weekday: 'short', month: 'short', day: 'numeric' 
          });
          
          addTooltip(dayDiv, dateStr, false, key);
        }

        weekDiv.appendChild(dayDiv);
        current.setDate(current.getDate() + 1);
      }
    }

    monthPositions.forEach((pos) => {
      const monthLabel = document.createElement("div");
      monthLabel.textContent = pos.month;
      monthLabel.style.gridColumn = `${pos.week + 1} / span 4`;
      monthsDiv.appendChild(monthLabel);
    });

    document.getElementById('currentYear').textContent = selectedYear;
    document.getElementById('prevYear').disabled = false;
    document.getElementById('nextYear').disabled = selectedYear >= currentYear;
  }

  function renderMonthlyView() {
    const monthGrid = document.getElementById('monthGrid');
    monthGrid.innerHTML = '';

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    for (let month = 0; month < 12; month++) {
      const monthCard = document.createElement('div');
      monthCard.className = 'month-card';

      const monthTitle = document.createElement('div');
      monthTitle.className = 'month-title';
      monthTitle.textContent = monthNames[month];
      monthCard.appendChild(monthTitle);

      const monthCalendar = document.createElement('div');
      monthCalendar.className = 'month-calendar';

      dayLabels.forEach(label => {
        const dayLabel = document.createElement('div');
        dayLabel.className = 'month-day-label';
        dayLabel.textContent = label;
        monthCalendar.appendChild(dayLabel);
      });

      const firstDay = new Date(selectedYear, month, 1);
      const lastDay = new Date(selectedYear, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'month-day empty';
        monthCalendar.appendChild(emptyDay);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(selectedYear, month, day);
        date.setHours(0, 0, 0, 0);
        const key = date.toISOString().split('T')[0];

        const dayDiv = document.createElement('div');
        dayDiv.className = 'month-day';
        dayDiv.textContent = day;

        const isFuture = date > today;
        const isToday = date.getTime() === today.getTime();

        if (isFuture) {
          dayDiv.classList.add('future');
        } else if (isToday) {
          dayDiv.classList.add('today');
          
          if (localStorage.getItem(key) === "1") {
            dayDiv.classList.add("completed");
          }

          dayDiv.addEventListener("click", () => {
            const isCompleted = dayDiv.classList.contains("completed");
            
            if (isCompleted) {
              dayDiv.classList.remove("completed");
              localStorage.setItem(key, "0");
            } else {
              dayDiv.classList.add("completed");
              localStorage.setItem(key, "1");
            }
            
            updateStats();
            renderMonthlyView();
          });
        } else {
          const storedValue = localStorage.getItem(key);
          
          if (storedValue === "1") {
            dayDiv.classList.add("completed");
          } else {
            dayDiv.classList.add("missed");
          }
        }

        const dateStr = date.toLocaleDateString('en-US', { 
          weekday: 'short', month: 'short', day: 'numeric' 
        });
        addTooltip(dayDiv, dateStr, isToday, key);

        monthCalendar.appendChild(dayDiv);
      }

      monthCard.appendChild(monthCalendar);
      monthGrid.appendChild(monthCard);
    }
  }

  function addTooltip(dayDiv, dateStr, isToday, key) {
    const tooltip = document.getElementById("tooltip");
    
    dayDiv.addEventListener("mouseenter", (e) => {
      let status;
      if (isToday) {
        status = dayDiv.classList.contains("completed") ? "‚úì Completed" : "Click to complete";
      } else {
        status = localStorage.getItem(key) === "1" ? "‚úì Completed" : "‚úó Missed";
      }
      tooltip.textContent = `${dateStr}${isToday ? ' (Today)' : ''} - ${status}`;
      tooltip.classList.add("show");
      updateTooltipPosition(e);
    });

    dayDiv.addEventListener("touchstart", (e) => {
      e.preventDefault();
      let status;
      if (isToday) {
        status = dayDiv.classList.contains("completed") ? "‚úì Completed" : "Tap to complete";
      } else {
        status = localStorage.getItem(key) === "1" ? "‚úì Completed" : "‚úó Missed";
      }
      tooltip.textContent = `${dateStr}${isToday ? ' (Today)' : ''} - ${status}`;
      tooltip.classList.add("show");
      const touch = e.touches[0];
      tooltip.style.left = (touch.pageX + 15) + "px";
      tooltip.style.top = (touch.pageY - 30) + "px";
      
      setTimeout(() => tooltip.classList.remove("show"), 2000);
    });

    dayDiv.addEventListener("mousemove", updateTooltipPosition);
    dayDiv.addEventListener("mouseleave", () => tooltip.classList.remove("show"));
  }

  function updateTooltipPosition(e) {
    const tooltip = document.getElementById("tooltip");
    tooltip.style.left = (e.pageX + 15) + "px";
    tooltip.style.top = (e.pageY - 30) + "px";
  }

  function changeYear(direction) {
    selectedYear += direction;
    if (currentView === 'year') {
      renderCalendar();
    } else {
      renderMonthlyView();
    }
    updateStats();
  }

  function updateStats() {
    let currentStreak = 0;
    let longestStreak = 0;
    let tempStreak = 0;
    let daysCompleted = 0;
    let daysMissed = 0;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yearStart = new Date(selectedYear, 0, 1);
    const yearEnd = new Date(selectedYear, 11, 31);
    const endDate = today < yearEnd ? today : yearEnd;
    
    let checkDate = new Date(yearStart);

    while (checkDate <= endDate) {
      const key = checkDate.toISOString().split("T")[0];
      const isCompleted = localStorage.getItem(key) === "1";

      if (isCompleted) {
        daysCompleted++;
        tempStreak++;
        if (tempStreak > longestStreak) {
          longestStreak = tempStreak;
        }
      } else {
        if (checkDate < today) {
          daysMissed++;
        }
        tempStreak = 0;
      }

      checkDate.setDate(checkDate.getDate() + 1);
    }

    checkDate = new Date(endDate);
    while (checkDate >= yearStart) {
      const key = checkDate.toISOString().split("T")[0];
      if (localStorage.getItem(key) === "1") {
        currentStreak++;
        checkDate.setDate(checkDate.getDate() - 1);
      } else {
        break;
      }
    }

    document.getElementById("currentStreak").textContent = currentStreak;
    document.getElementById("longestStreak").textContent = longestStreak;
    document.getElementById("daysCompleted").textContent = daysCompleted;
    document.getElementById("daysMissed").textContent = daysMissed;
  }

  // Share Stats as Image
  function shareStats() {
    const canvas = document.getElementById('shareCanvas');
    const ctx = canvas.getContext('2d');
    
    const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
    const bgColor = isDark ? '#0d1117' : '#ffffff';
    const textColor = isDark ? '#c9d1d9' : '#24292f';
    const accentColor = '#58a6ff';
    const greenColor = '#39d353';
    const orangeColor = '#f97316';
    const redColor = '#f85149';

    canvas.width = 1200;
    canvas.height = 630;

    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = textColor;
    ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('My Habit Tracker', canvas.width / 2, 80);

    ctx.fillStyle = accentColor;
    ctx.font = 'bold 36px -apple-system';
    ctx.fillText(selectedYear, canvas.width / 2, 130);

    const stats = [
      { label: 'Current Streak', value: document.getElementById("currentStreak").textContent, color: orangeColor, x: 200 },
      { label: 'Longest Streak', value: document.getElementById("longestStreak").textContent, color: accentColor, x: 500 },
      { label: 'Completed', value: document.getElementById("daysCompleted").textContent, color: greenColor, x: 800 },
      { label: 'Missed', value: document.getElementById("daysMissed").textContent, color: redColor, x: 1100 }
    ];

    stats.forEach(stat => {
      ctx.fillStyle = stat.color;
      ctx.font = 'bold 72px -apple-system';
      ctx.textAlign = 'center';
      ctx.fillText(stat.value, stat.x, 250);

      ctx.fillStyle = textColor;
      ctx.font = '20px -apple-system';
      ctx.fillText(stat.label, stat.x, 290);
    });

    const startY = 350;
    const cellSize = 12;
    const gap = 3;
    const yearStart = new Date(selectedYear, 0, 1);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let x = 100;
    let y = startY;
    let date = new Date(yearStart);

    ctx.font = '14px -apple-system';
    ctx.fillStyle = textColor;
    ctx.textAlign = 'left';
    ctx.fillText('Activity Overview:', 100, startY - 20);

    for (let i = 0; i < 365; i++) {
      const key = date.toISOString().split('T')[0];
      const isCompleted = localStorage.getItem(key) === "1";
      const isFuture = date > today;

      if (isFuture) {
        ctx.fillStyle = isDark ? '#21262d' : '#e1e4e8';
        ctx.globalAlpha = 0.3;
      } else if (isCompleted) {
        ctx.fillStyle = greenColor;
        ctx.globalAlpha = 1;
      } else {
        ctx.fillStyle = isDark ? '#1c1c1c' : '#d0d7de';
        ctx.globalAlpha = 0.6;
      }

      ctx.fillRect(x, y, cellSize, cellSize);
      ctx.globalAlpha = 1;

      y += cellSize + gap;
      if (y > startY + (cellSize + gap) * 6) {
        y = startY;
        x += cellSize + gap;
      }

      date.setDate(date.getDate() + 1);
    }

    ctx.fillStyle = textColor;
    ctx.font = '18px -apple-system';
    ctx.textAlign = 'center';
    const completionRate = parseInt(document.getElementById("daysCompleted").textContent) + parseInt(document.getElementById("daysMissed").textContent);
    const rate = completionRate > 0 ? Math.round((parseInt(document.getElementById("daysCompleted").textContent) / completionRate) * 100) : 0;
    ctx.fillText(`Completion Rate: ${rate}%`, canvas.width / 2, 600);

    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `habit-tracker-${selectedYear}-${new Date().toISOString().split('T')[0]}.png`;
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  function exportStats() {
    const stats = {
      currentStreak: document.getElementById("currentStreak").textContent,
      longestStreak: document.getElementById("longestStreak").textContent,
      daysCompleted: document.getElementById("daysCompleted").textContent,
      daysMissed: document.getElementById("daysMissed").textContent,
      totalDays: parseInt(document.getElementById("daysCompleted").textContent) + 
                  parseInt(document.getElementById("daysMissed").textContent)
    };

    const today = new Date();
    const yearStart = new Date(selectedYear, 0, 1);
    const daysSinceJan1 = Math.floor((today - yearStart) / (1000 * 60 * 60 * 24)) + 1;

    let txt = `HABIT TRACKER STATS - ${selectedYear}\n`;
    txt += `============================\n\n`;
    txt += `Export Date: ${today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n`;
    txt += `OVERVIEW\n`;
    txt += `--------\n`;
    if (selectedYear === today.getFullYear()) {
      txt += `Days since Jan 1: ${daysSinceJan1}\n`;
    }
    txt += `Days completed: ${stats.daysCompleted}\n`;
    txt += `Days missed: ${stats.daysMissed}\n`;
    txt += `Completion rate: ${stats.totalDays > 0 ? Math.round((stats.daysCompleted / stats.totalDays) * 100) : 0}%\n\n`;
    txt += `STREAKS\n`;
    txt += `-------\n`;
    txt += `Current streak: ${stats.currentStreak} days\n`;
    txt += `Longest streak: ${stats.longestStreak} days\n`;

    const blob = new Blob([txt], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `habit-tracker-stats-${selectedYear}-${today.toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function backupData() {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      allData[key] = localStorage.getItem(key);
    }

    const backup = {
      version: "1.0",
      exportDate: new Date().toISOString(),
      data: allData
    };

    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `habit-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function restoreData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const backup = JSON.parse(e.target.result);
        if (backup.version && backup.data) {
          pendingRestoreData = backup.data;
          document.getElementById('confirmModal').classList.add('show');
        } else {
          alert('Invalid backup file format!');
        }
      } catch (error) {
        alert('Error reading backup file!');
      }
    };
    reader.readAsText(file);
    
    event.target.value = '';
  }

  function confirmRestore() {
    if (pendingRestoreData) {
      localStorage.clear();
      for (const [key, value] of Object.entries(pendingRestoreData)) {
        localStorage.setItem(key, value);
      }
      pendingRestoreData = null;
      closeModal();
      renderCalendar();
      updateStats();
      alert('‚úì Data restored successfully!');
    }
  }

  function closeModal() {
    document.getElementById('confirmModal').classList.remove('show');
    pendingRestoreData = null;
  }

  loadTheme();
  checkNotificationStatus();
  renderCalendar();
  updateStats();

  setInterval(() => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    const stored = new Date(selectedYear, 0, 1);
    if (now.getFullYear() !== stored.getFullYear() && selectedYear === new Date().getFullYear()) {
      location.reload();
    }
  }, 60000);
</script>

</body>
</html>